{{ define "main" }}
<div class="search-page">
  <h1>Search</h1>

  <div class="search-box">
    <input
      type="search"
      id="search-input"
      class="search-input"
      placeholder="Type to search..."
      autofocus
    >
  </div>

  <div id="search-results" class="search-results">
    <p class="search-hint">Start typing to search posts...</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
<script>
(function() {
  const searchInput = document.getElementById('search-input');
  const resultsContainer = document.getElementById('search-results');
  let fuse = null;
  let searchIndex = null;

  // Get query parameter
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q') || '';

  if (initialQuery) {
    searchInput.value = initialQuery;
  }

  // Fetch the search index
  fetch('{{ "index.json" | relURL }}')
    .then(response => response.json())
    .then(data => {
      searchIndex = data;

      // Initialize Fuse.js
      fuse = new Fuse(searchIndex, {
        keys: [
          { name: 'title', weight: 0.4 },
          { name: 'description', weight: 0.3 },
          { name: 'content', weight: 0.2 },
          { name: 'tags', weight: 0.1 }
        ],
        includeScore: true,
        threshold: 0.2,
        ignoreLocation: true,
        minMatchCharLength: 3
      });

      // Run initial search if query exists
      if (initialQuery) {
        performSearch(initialQuery);
      }
    })
    .catch(error => {
      console.error('Failed to load search index:', error);
      resultsContainer.innerHTML = '<p class="search-error">Failed to load search index.</p>';
    });

  // Debounce function
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Perform search
  function performSearch(query) {
    if (!fuse || !query.trim()) {
      resultsContainer.innerHTML = '<p class="search-hint">Start typing to search posts...</p>';
      return;
    }

    const results = fuse.search(query);

    if (results.length === 0) {
      resultsContainer.innerHTML = `<p class="search-no-results">No results found for "<strong>${escapeHtml(query)}</strong>"</p>`;
      return;
    }

    const html = results.map(result => {
      const item = result.item;
      const tags = item.tags ? item.tags.map(tag =>
        `<span class="search-tag">${escapeHtml(tag)}</span>`
      ).join('') : '';

      return `
        <article class="search-result">
          <h2><a href="${item.url}">${escapeHtml(item.title)}</a></h2>
          <p class="search-result__meta">${item.date}</p>
          <p class="search-result__desc">${escapeHtml(item.description)}</p>
          ${tags ? `<div class="search-result__tags">${tags}</div>` : ''}
        </article>
      `;
    }).join('');

    resultsContainer.innerHTML = `
      <p class="search-count">${results.length} result${results.length === 1 ? '' : 's'} for "<strong>${escapeHtml(query)}</strong>"</p>
      ${html}
    `;

    // Update URL
    const newUrl = new URL(window.location);
    newUrl.searchParams.set('q', query);
    history.replaceState(null, '', newUrl);
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Listen for input
  searchInput.addEventListener('input', debounce(function() {
    performSearch(this.value);
  }, 200));

  // Handle Enter key
  searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      performSearch(this.value);
    }
  });
})();
</script>

<style>
.search-page {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

.search-page h1 {
  margin-bottom: 1.5rem;
}

.search-box {
  margin-bottom: 2rem;
}

.search-input {
  width: 100%;
  padding: 0.75rem 1rem;
  font-size: 1.1rem;
  border: 2px solid var(--accent-color-lite);
  border-radius: 8px;
  background: var(--body-background);
  color: var(--body-font-color);
  transition: border-color 0.2s ease;
}

.search-input:focus {
  outline: none;
  border-color: #C51A4A;
}

.search-results {
  margin-top: 1rem;
}

.search-hint,
.search-no-results,
.search-error {
  color: var(--body-font-color);
  opacity: 0.7;
  font-style: italic;
}

.search-count {
  margin-bottom: 1.5rem;
  color: var(--body-font-color);
  opacity: 0.8;
}

.search-result {
  padding: 1.25rem 0;
  border-bottom: 1px solid var(--accent-color-lite);
}

.search-result:last-child {
  border-bottom: none;
}

.search-result h2 {
  margin: 0 0 0.5rem 0;
  font-size: 1.25rem;
}

.search-result h2 a {
  color: var(--link-color);
  text-decoration: none;
}

.search-result h2 a:hover {
  text-decoration: underline;
}

.search-result__meta {
  font-size: 0.85rem;
  color: var(--body-font-color);
  opacity: 0.6;
  margin: 0 0 0.5rem 0;
}

.search-result__desc {
  margin: 0 0 0.75rem 0;
  line-height: 1.5;
}

.search-result__tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.search-tag {
  display: inline-block;
  padding: 0.2rem 0.6rem;
  font-size: 0.8rem;
  background: var(--accent-color-lite);
  border-radius: 12px;
  color: var(--body-font-color);
}
</style>
{{ end }}
